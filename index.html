<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚¨ãƒ³ãƒ‰ãƒ¬ã‚¹è½ä¸‹ã‚²ãƒ¼ãƒ </title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #eee;
      font-family: sans-serif;
      user-select: none;
    }
    /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã¯ç”»é¢ã„ã£ã±ã„ã®æ¨ªå¹…ã€ã‹ã¤ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¾ãƒ¼ãƒ³åˆ†ã®é«˜ã•ã‚’é™¤ã */
    canvas {
      display: block;
      background-color: #87CEEB;
    }
    /* ç”»é¢ä¸‹éƒ¨ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¾ãƒ¼ãƒ³ï¼šã‚¸ãƒ£ãƒ³ãƒ—ãƒœã‚¿ãƒ³ã®ã¿ */
    #controls {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 100px; /* CONTROL_ZONE_HEIGHT */
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0;
      padding: 0;
    }
    #controls button {
      font-size: 24px;
      border: none;
      background-color: #fff;
      padding: 15px 30px;
      border-radius: 10px;
    }
    /* ç”»é¢ä¸­å¤®ã«é…ç½®ã™ã‚‹ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ */
    #startBtn {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 30px;
      padding: 15px 30px;
      border: none;
      border-radius: 10px;
      background-color: #fff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
      z-index: 200;
      display: none; /* ã‚²ãƒ¼ãƒ é–‹å§‹å¾Œã¯éè¡¨ç¤º */
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <div id="controls">
    <button id="jumpBtn">ã‚¸ãƒ£ãƒ³ãƒ—</button>
  </div>
  <button id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  
  <script>
    (function(){
      "use strict";
      // å®šæ•°ï¼ˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¾ãƒ¼ãƒ³ã®é«˜ã•ï¼‰
      const CONTROL_ZONE_HEIGHT = 100;
      
      // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ãƒªã‚µã‚¤ã‚ºï¼šç”»é¢æ¨ªå¹…å…¨ä½“ã€ç¸¦ã¯ (window.innerHeight - CONTROL_ZONE_HEIGHT)
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const resizeCanvas = () => {
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight - CONTROL_ZONE_HEIGHT;
      };
      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();
      
      // ã‚µã‚¤ã‚ºèª¿æ•´ã®ãŸã‚ã®å®šæ•°å¤‰æ›´ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå¤§ãããªã‚‹ã‚ˆã†ã«å¤‰æ›´ï¼‰
      let BASE_SCROLL_SPEED = 1;
      let BASE_GRAVITY = 0.3;
      const BAR_MIN_WIDTH = 70, BAR_MAX_WIDTH = 210, BAR_HEIGHT = 15;
      const ENEMY_PROBABILITY = 0.3, ENEMY_SIZE = 22;
      const ITEM_SIZE = 30;
      const LIFE_ICON_SIZE = 36, LIFE_SPACING = 45;
      
      // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç†ï¼š"start" / "playing" / "gameover"
      let gameState = "start";
      let startTime, score, bonusScore, cameraOffset, barTransparentTimer, hasUpdatedHighScore;
      let bars, items, effects, nextBarY, nextItemY;
      
      const player = {
        x: canvas.width/2 - 25,
        y: 100,
        width: 50,
        height: 50,
        vx: 0,
        vy: 0,
        speed: 3,
        jumpStrength: -12,
        onBar: false,
        lives: 3,
        maxLives: 3,
        invincible: false,
        invincibleTimer: 0
      };
      
      let highScore = parseInt(localStorage.getItem("highScore")) || 0;
      const keys = {}; // PCç”¨ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ
      
      // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
      const random = (min, max) => Math.floor(Math.random()*(max-min+1)) + min;
      function rectsIntersect(ax, ay, aw, ah, bx, by, bw, bh) {
          return ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by;
      }
      
      // PCç”¨ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆ
      document.addEventListener("keydown", (e) => {
         if(["ArrowLeft", "ArrowRight", "Space"].includes(e.code)) e.preventDefault();
         // ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆ"start" ã¾ãŸã¯ "gameover" çŠ¶æ…‹ã®å ´åˆï¼‰
         if(e.code === "Space") {
             if(gameState === "start" || gameState === "gameover") {
                 initGame();
                 document.getElementById("startBtn").style.display = "none";
                 return;
             }
         }
         keys[e.code] = true;
      });
      document.addEventListener("keyup", (e) => { keys[e.code] = false; });
      
      // ã‚¸ãƒ£ãƒ³ãƒ—ãƒœã‚¿ãƒ³ï¼ˆã‚¹ãƒãƒ›ãƒ»PCå…±é€šï¼‰ã«ã‚ˆã‚‹æ“ä½œ
      const jumpBtn = document.getElementById("jumpBtn");
      jumpBtn.addEventListener("touchstart", (e)=>{
          e.preventDefault();
          if(gameState === "playing" && player.onBar) {
              player.vy = player.jumpStrength;
              player.onBar = false;
          }
      });
      jumpBtn.addEventListener("mousedown", (e)=>{
          e.preventDefault();
          if(gameState === "playing" && player.onBar) {
              player.vy = player.jumpStrength;
              player.onBar = false;
          }
      });
      
      // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³
      const startBtn = document.getElementById("startBtn");
      startBtn.addEventListener("click", (e)=>{
          e.preventDefault();
          initGame();
          startBtn.style.display = "none";
      });
      
      // ã‚¿ãƒƒãƒæ“ä½œã§å·¦å³ç§»å‹•ï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹é ˜åŸŸï¼‰
      function handleTouch(e) {
          // ã‚¿ãƒƒãƒä½ç½®ã«å¿œã˜ã¦å·¦å³ã®ç§»å‹•ã‚­ãƒ¼ã‚’è¨­å®š
          keys["ArrowLeft"] = false;
          keys["ArrowRight"] = false;
          for(let i = 0; i < e.touches.length; i++){
              const touch = e.touches[i];
              const touchX = touch.clientX;
              if(touchX < window.innerWidth / 2){
                  keys["ArrowLeft"] = true;
              } else {
                  keys["ArrowRight"] = true;
              }
          }
      }
      function handleTouchEnd(e) {
          if(e.touches.length === 0){
              keys["ArrowLeft"] = false;
              keys["ArrowRight"] = false;
          } else {
              handleTouch(e);
          }
      }
      canvas.addEventListener("touchstart", handleTouch);
      canvas.addEventListener("touchmove", handleTouch);
      canvas.addEventListener("touchend", handleTouchEnd);
      
      // ãƒãƒ¼ç”Ÿæˆ
      function spawnBars() {
         while(nextBarY < cameraOffset + canvas.height + 200) {
             const barWidth = random(BAR_MIN_WIDTH, BAR_MAX_WIDTH);
             const barX = random(0, canvas.width - barWidth);
             let type = "normal";
             const r = Math.random();
             if(r >= 0.7 && r < 0.85) type = "green";
             else if(r >= 0.85) type = "blue";
             const bar = { x: barX, y: nextBarY, width: barWidth, height: BAR_HEIGHT, type, enemy: null };
             if(type === "blue") {
                bar.vx = (Math.random() < 0.5 ? -1 : 1) * (Math.random()*1 + 0.5);
             }
             if(Math.random() < ENEMY_PROBABILITY) {
                const enemyX = random(barX, barX + barWidth - ENEMY_SIZE);
                bar.enemy = { x: enemyX, y: nextBarY - ENEMY_SIZE, size: ENEMY_SIZE, vx: (Math.random() < 0.5 ? -1 : 1) * (Math.random()*0.5 + 0.5) };
             }
             bars.push(bar);
             nextBarY += random(80,150);
         }
      }
      
      // ã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆ
      function spawnItems() {
         while(nextItemY < cameraOffset + canvas.height + 200) {
            const itemX = random(0, canvas.width - ITEM_SIZE);
            items.push({ x: itemX, y: nextItemY, size: ITEM_SIZE });
            nextItemY += random(200,300);
         }
      }
      
      // æ›´æ–°å‡¦ç†ï¼ˆ"playing" çŠ¶æ…‹ã®ã¿ï¼‰
      function update() {
          if(gameState !== "playing") return;
          const elapsed = (Date.now() - startTime) / 1000;
          score = Math.floor(elapsed * 10) + bonusScore;
          const currentScrollSpeed = BASE_SCROLL_SPEED + elapsed * 0.05;
          const currentGravity = BASE_GRAVITY + elapsed * 0.02;
          cameraOffset += currentScrollSpeed;
          
          // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç§»å‹•ï¼ˆPCã®å·¦å³ã‚­ãƒ¼ãŠã‚ˆã³ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚¿ãƒƒãƒæ“ä½œï¼‰
          if(keys["ArrowLeft"]) player.x -= player.speed;
          if(keys["ArrowRight"]) player.x += player.speed;
          player.x = Math.max(0, Math.min(player.x, canvas.width - player.width));
          
          // PCã§ã®ã‚¸ãƒ£ãƒ³ãƒ—ã¯ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ï¼ˆã‚²ãƒ¼ãƒ ä¸­ã¯æ—¢ã«ã‚¹ã‚¿ãƒ¼ãƒˆæ¸ˆã¿ï¼‰
          if(keys["Space"] && player.onBar && gameState === "playing") {
              player.vy = player.jumpStrength;
              player.onBar = false;
          }
          player.vy += currentGravity;
          player.y += player.vy;
          
          // é’ãƒãƒ¼ã®å·¦å³ç§»å‹•
          for(let bar of bars) {
              if(bar.type === "blue") {
                  bar.x += bar.vx;
                  if(bar.x < 0) { bar.x = 0; bar.vx = -bar.vx; }
                  if(bar.x + bar.width > canvas.width) { bar.x = canvas.width - bar.width; bar.vx = -bar.vx; }
              }
          }
          // æ•µã®ç§»å‹•
          for(let bar of bars) {
              if(bar.enemy) {
                  bar.enemy.x += bar.enemy.vx;
                  if(bar.enemy.x < bar.x) { bar.enemy.x = bar.x; bar.enemy.vx = -bar.enemy.vx; }
                  if(bar.enemy.x + bar.enemy.size > bar.x + bar.width) { bar.enemy.x = bar.x + bar.width - bar.enemy.size; bar.enemy.vx = -bar.enemy.vx; }
              }
          }
          
          // ä¸Šéƒ¨è¡çªå‡¦ç†
          const playerScreenY = player.y - cameraOffset;
          if(playerScreenY < 0 && barTransparentTimer <= 0) {
              player.lives--;
              if(player.lives <= 0) gameState = "gameover";
              barTransparentTimer = 10;
              player.vy = 5;
          }
          if(barTransparentTimer > 0) barTransparentTimer--;
          
          spawnBars();
          spawnItems();
          
          // ãƒãƒ¼ã¨ã®è¡çªåˆ¤å®š
          if(barTransparentTimer <= 0) {
             player.onBar = false;
             for(let bar of bars) {
                if(player.x < bar.x + bar.width && player.x + player.width > bar.x) {
                   if(player.vy >= 0 &&
                      player.y + player.height >= bar.y &&
                      player.y + player.height <= bar.y + BAR_HEIGHT + player.vy) {
                         if(bar.type === "green") {
                             player.y = bar.y - player.height;
                             player.vy = player.jumpStrength;
                             player.onBar = true;
                         } else if(bar.type === "blue") {
                             player.y = bar.y - player.height;
                             player.vy = 0;
                             player.onBar = true;
                             player.x += bar.vx;
                         } else {
                             player.y = bar.y - player.height;
                             player.vy = 0;
                             player.onBar = true;
                         }
                         break;
                   }
                }
             }
          }
          
          // æ•µã¨ã®è¡çª
          for(let bar of bars) {
              if(bar.enemy && rectsIntersect(player.x, player.y, player.width, player.height,
                                              bar.enemy.x, bar.enemy.y, bar.enemy.size, bar.enemy.size)) {
                 if(!player.invincible) {
                     player.lives--;
                     if(player.lives <= 0) gameState = "gameover";
                     player.invincible = true;
                     player.invincibleTimer = 60;
                 }
              }
          }
          
          // ã‚¢ã‚¤ãƒ†ãƒ ã¨ã®è¡çª
          for(let i = items.length - 1; i >= 0; i--) {
              const item = items[i];
              if(rectsIntersect(player.x, player.y, player.width, player.height,
                                item.x, item.y, item.size, item.size)) {
                 bonusScore += 100;
                 effects.push({ x: item.x + item.size/2, y: item.y, alpha: 1, timer: 30, text: "âœ¨" });
                 items.splice(i,1);
              }
          }
          
          // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆæ›´æ–°
          for(let i = effects.length - 1; i >= 0; i--) {
              const eff = effects[i];
              eff.timer--;
              eff.y -= 0.5;
              eff.alpha = eff.timer / 30;
              if(eff.timer <= 0) effects.splice(i,1);
          }
          
          if(player.invincible) {
              player.invincibleTimer--;
              if(player.invincibleTimer <= 0) player.invincible = false;
          }
          
          // ä¸‹éƒ¨è¡çªåˆ¤å®š
          if(player.y - cameraOffset + player.height > canvas.height) gameState = "gameover";
      }
      
      // æç”»å‡¦ç†
      function draw() {
          if(gameState === "gameover" && !hasUpdatedHighScore) {
              if(score > highScore) {
                  highScore = score;
                  localStorage.setItem("highScore", highScore);
              }
              hasUpdatedHighScore = true;
          }
          ctx.clearRect(0,0, canvas.width, canvas.height);
          ctx.fillStyle = "#87CEEB";
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          
          // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢è¡¨ç¤ºï¼ˆ"start" çŠ¶æ…‹ï¼‰
          if(gameState === "start") {
              ctx.fillStyle = "black";
              ctx.font = "30px sans-serif";
              ctx.textAlign = "center";
              ctx.textBaseline = "middle";
              ctx.fillText("ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‹ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§é–‹å§‹", canvas.width/2, canvas.height/2);
              return;
          }
          
          // ãƒãƒ¼ãƒ»æ•µã®æç”»
          ctx.globalAlpha = (barTransparentTimer > 0 ? 0.3 : 1);
          for(let bar of bars) {
              const barScreenY = bar.y - cameraOffset;
              if(barScreenY + bar.height >= -20 && barScreenY <= canvas.height + 20) {
                  ctx.fillStyle = (bar.type === "green" ? "green" : (bar.type === "blue" ? "blue" : "#654321"));
                  ctx.fillRect(bar.x, barScreenY, bar.width, BAR_HEIGHT);
                  if(bar.enemy) {
                      const enemyScreenY = bar.enemy.y - cameraOffset;
                      ctx.font = bar.enemy.size + "px sans-serif";
                      ctx.textAlign = "center";
                      ctx.textBaseline = "middle";
                      ctx.fillText("ğŸ‘¾", bar.enemy.x + bar.enemy.size/2, enemyScreenY + bar.enemy.size/2);
                  }
              }
          }
          ctx.globalAlpha = 1;
          
          // ã‚¢ã‚¤ãƒ†ãƒ æç”»
          ctx.font = "36px sans-serif";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          for(let item of items) {
              const itemScreenY = item.y - cameraOffset;
              if(itemScreenY > -20 && itemScreenY < canvas.height + 20) {
                  ctx.fillText("ğŸ°", item.x + item.size/2, itemScreenY + item.size/2);
              }
          }
          
          // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æç”»ï¼ˆãƒšãƒ³ã‚®ãƒ³ğŸ§ï¼‰
          const playerScreenY = player.y - cameraOffset;
          if(player.invincible) ctx.globalAlpha = 0.5;
          ctx.font = "50px sans-serif";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText("ğŸ§", player.x + player.width/2, playerScreenY + player.height/2);
          ctx.globalAlpha = 1;
          
          // ã‚¹ã‚³ã‚¢ãƒ»ãƒã‚¤ã‚¹ã‚³ã‚¢è¡¨ç¤º
          ctx.fillStyle = "black";
          ctx.font = "20px sans-serif";
          ctx.textAlign = "center";
          ctx.fillText("High Score: " + highScore, canvas.width/2, 20);
          ctx.textAlign = "left";
          ctx.fillText("Score: " + score, 10, 50);
          
          // ãƒªãƒƒãƒãªãƒ©ã‚¤ãƒ•è¡¨ç¤ºï¼ˆãƒšãƒ³ã‚®ãƒ³ã‚¢ã‚¤ã‚³ãƒ³ï¼‰
          const startX = canvas.width - (player.maxLives * LIFE_SPACING) - 10;
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.shadowColor = "rgba(0,0,0,0.3)";
          ctx.shadowBlur = 4;
          for(let i = 0; i < player.maxLives; i++) {
              ctx.globalAlpha = i < player.lives ? 1 : 0.3;
              ctx.font = LIFE_ICON_SIZE + "px sans-serif";
              ctx.fillText("ğŸ§", startX + i * LIFE_SPACING + LIFE_SPACING/2, 50);
          }
          ctx.globalAlpha = 1;
          ctx.shadowBlur = 0;
          
          // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆæç”»
          ctx.save();
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          for(let eff of effects) {
              ctx.globalAlpha = eff.alpha;
              ctx.font = "50px sans-serif";
              ctx.fillText(eff.text, eff.x, eff.y - cameraOffset);
          }
          ctx.restore();
          ctx.globalAlpha = 1;
          
          // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
          if(gameState === "gameover") {
              ctx.fillStyle = "rgba(0,0,0,0.6)";
              ctx.fillRect(0,0, canvas.width, canvas.height);
              ctx.fillStyle = "white";
              ctx.font = "40px sans-serif";
              ctx.textAlign = "center";
              ctx.textBaseline = "middle";
              ctx.fillText("GAME OVER", canvas.width/2, canvas.height/2);
              // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’å†è¡¨ç¤º
              startBtn.style.display = "block";
          }
      }
      
      // ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ï¼ˆæç”»ã¯å¸¸ã«å®Ÿè¡Œï¼‰
      function gameLoop() {
          if(gameState === "playing") update();
          draw();
          requestAnimationFrame(gameLoop);
      }
      
      function initGame() {
          gameState = "playing";
          cameraOffset = 0;
          startTime = Date.now();
          score = bonusScore = 0;
          barTransparentTimer = 0;
          hasUpdatedHighScore = false;
          effects = [];
          nextBarY = 150;
          nextItemY = 200;
          player.x = canvas.width/2 - player.width/2;
          player.y = 100;
          player.vx = player.vy = 0;
          player.onBar = false;
          player.lives = player.maxLives;
          player.invincible = false;
          player.invincibleTimer = 0;
          bars = [];
          items = [];
          spawnBars();
          spawnItems();
      }
      
      // åˆå›ã¯ã‚¹ã‚¿ãƒ¼ãƒˆçŠ¶æ…‹ã«ã™ã‚‹
      gameState = "start";
      startBtn.style.display = "block";
      gameLoop();
      
    })();
  </script>
</body>
</html>
